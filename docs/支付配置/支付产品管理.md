# 思方支付管理系统 - 支付产品管理

## 业务目标

提供支付产品的全生命周期管理功能，包括产品创建、配置、启用/禁用和删除，实现对支付产品及其关联供应商通道的统一管理。

## 业务逻辑

### 产品查询逻辑

**查询条件**:
- 支付产品ID：精确匹配产品唯一标识
- 支付产品名称：模糊匹配产品名称
- 支付产品编码：模糊匹配产品编码

### 产品基础配置

**产品属性**:
- 产品名称：必填，2-50个字符
- 产品编码：必填，只能包含字母、数字和下划线
- 商户费率：必填，百分比形式表示，如 0.5%
- 启用状态：ONLINE(启用)或OFFLINE(禁用)
- 轮询方式：POLLING(轮询)或WEIGHT(权重)
- 是否同步费率到商户：YES(是)或NO(否)
- 备注：选填，用于记录产品的补充说明

### 费率管理逻辑

**定时费率变更**:
- 支持设置费率定时生效功能
- 可以预先设定费率变更的具体时间
- 系统会在指定时间自动应用新费率
- 定时费率支持显示剩余生效时间（如：1天3小时后生效）
- 定时费率变更记录随产品数据一起导出

**费率生效规则**:
- 常规更新：费率变更立即生效
- 定时更新：费率变更在指定时间生效，在生效前显示当前费率和待生效费率
- 费率变更时间必须晚于当前时间

### 通道配置逻辑

**通道关联规则**:
- 一个支付产品可关联多个供应商通道
- 支持单独选择通道或选择通道分组
- 选择通道分组后，自动关联该分组下的所有通道
- 每个通道配置独立的权重和费率

**权重配置规则**:
- 轮询方式为"权重"时生效
- 权重范围：1-100的整数
- 权重值决定通道被选中的概率：权重越高，被选中概率越大
- 权重计算公式：
  ```
  通道被选中概率 = 该通道权重 / 所有可用通道权重总和
  ```

**通道费率规则**:
- 每个通道可设置独立的通道费率
- 通道费率必须小于等于商户费率
- 差值为平台利润
- 费率计算公式：
  ```
  平台利润率 = 商户费率 - 通道费率
  ```

### 产品状态管理

**状态切换逻辑**:
- 单个产品状态切换：
  - ONLINE → OFFLINE：禁用产品，停止新交易，不影响已有交易
  - OFFLINE → ONLINE：启用产品，允许新交易进入
- 批量状态管理：
  - 产品一键开启：所有产品状态设置为ONLINE
  - 产品一键关闭：所有产品状态设置为OFFLINE
  - 下单一键关闭：关闭所有产品的下单功能，但保留查询等其他功能

**操作确认规则**:
- 单个产品状态变更需二次确认
- 批量操作必须二次确认
- 重要操作（如删除）需二次确认

### 产品关联商户逻辑

**费率同步规则**:
- 同步费率到商户开启时：
  - 产品费率变更后，自动更新所有关联商户的费率
  - 新商户关联产品时，自动继承产品费率
- 同步费率到商户关闭时：
  - 产品费率变更不影响已关联商户的费率
  - 商户可单独设置与产品不同的费率

### 产品安全控制

**关键操作安全控制**:
- 新增和编辑产品时需验证超级密码
- 批量操作需要高级权限
- 删除产品前检查是否有关联的商户或交易记录

## 数据导出逻辑

- 支持将当前筛选条件下的产品数据导出为Excel文件
- 导出内容包括产品基本信息、关联通道信息和定时费率变更信息
- 导出文件命名规则：支付产品列表_YYYYMMDD_HHMMSS.xlsx

## 自动任务

- 系统每分钟检查一次是否有定时费率需要生效
- 当达到预设时间时，自动应用新费率并发送成功提示
- 费率生效后，自动禁用定时费率设置，避免重复应用

## 权限控制

- 查看权限：具有"支付配置/查看"权限的角色可访问列表
- 操作权限：
  - 产品新增：需要"支付配置/新增"权限
  - 产品编辑：需要"支付配置/编辑"权限
  - 产品删除：需要"支付配置/删除"权限
  - 状态变更：需要"支付配置/状态管理"权限
  - 批量操作：需要"支付配置/批量操作"权限
- 数据范围权限：管理员可能被限制只能查看和管理特定范围的产品 