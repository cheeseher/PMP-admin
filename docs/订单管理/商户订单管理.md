# 思方支付管理系统 - 商户订单管理

## 业务目标

提供全面的商户支付订单管理功能，支持多维度查询、数据统计和订单操作，帮助管理员高效监控和处理支付交易。

## 业务逻辑

### 订单查询逻辑

**时间筛选**:
- 支持按订单创建时间和完成时间进行筛选
- 创建时间提供快捷选项：今日、昨日、最近7天、自定义时间段
- 自定义时间段需要选择开始日期和结束日期

**订单标识筛选**:
- 平台单号：系统内部的唯一订单标识
- 商户单号：商户系统提供的外部订单标识
- 上游单号：上游支付通道返回的通道订单标识

**商户信息筛选**:
- 商户ID：商户的唯一标识
- 商户账户：商户的登录账户
- 商户名称：商户的显示名称

**支付信息筛选**:
- 支付产品：支持按支付产品名称筛选（支付宝、微信支付等）
- 支付产品编码：产品的系统编码
- 供应商：上游支付供应商筛选
- 供应商通道：具体的支付通道筛选
- 通道编码：通道的系统编码

**订单状态筛选**:
- 订单状态：包括订单创建、交易成功、待付款、交易中、交易失败、申诉中、拉单失败、交易撤销、补单成功等

### 数据统计逻辑

统计区域展示当前筛选条件下的订单数据汇总：

**交易量统计**:
```
总跑量 = SUM(符合筛选条件的所有订单金额)
总成功单数 = COUNT(符合筛选条件且状态为"交易成功"或"补单成功"的订单)
成功金额 = SUM(符合筛选条件且状态为"交易成功"或"补单成功"的订单金额)
成功率 = (总成功单数 / 符合筛选条件的总订单数) * 100%
补单单数 = COUNT(符合筛选条件且为"补单成功"的订单)
```

**财务统计**:
```
总折扣金额 = SUM(符合筛选条件的所有订单的折扣金额)
总利润 = SUM(手续费) - SUM(通道成本)
商户折扣 = SUM(所有订单的手续费)
上游通道成本 = SUM(所有订单的通道成本)
```

### 订单处理逻辑

**操作权限**:
- 订单查看：所有管理员可查看订单详情
- 重新推送：对接入商户系统的订单进行回调重试
- 手动补单：对支付通道已确认但系统未记录成功的订单进行手动确认
- 修改金额：特殊情况下允许调整订单金额（需记录操作日志）

**状态流转**:
- 正常流程：订单创建 → 待付款 → 交易中 → 交易成功/交易失败
- 特殊流程：
  - 拉单失败 → 手动补单 → 补单成功
  - 交易失败 → 申诉中 → 交易成功（申诉成功）/交易失败（申诉失败）
  - 待付款 → 交易撤销（超时/主动取消）

**推送状态**:
- 未推送：订单未向商户系统发送回调
- 已推送/成功：订单回调已成功发送且得到商户系统确认
- 已推送/失败：订单回调发送失败或未得到商户系统确认

### 订单金额处理

**金额计算逻辑**:
```
入账金额 = 订单金额 - 手续费
手续费 = 订单金额 * 商户费率
通道成本 = 订单金额 * 上游通道费率
利润 = 手续费 - 通道成本
```

**金额修改规则**:
- 仅允许有特殊权限的管理员修改
- 修改前需确认原始金额
- 修改后需记录操作人、操作时间、修改前后金额
- 金额修改会触发相关费用的重新计算

## 数据导出逻辑

- 支持将当前筛选条件下的订单数据导出为Excel文件
- 导出内容包括表格中显示的全部字段
- 导出文件命名规则：商户订单_YYYYMMDD_HHMMSS.xlsx

## 权限控制

- 查看权限：具有"订单管理/查看"权限的角色可访问列表
- 操作权限：
  - 推送操作：需要"订单管理/推送"权限
  - 补单操作：需要"订单管理/补单"权限
  - 修改金额：需要"订单管理/修改"权限
- 数据范围权限：根据管理员级别限制可查看的商户范围 